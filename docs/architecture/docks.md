# Docks

![Docks](https://raw.githubusercontent.com/gcba-iris/iris-tech-docs/master/images/architecture/docks.png)


## Description

Listens to one or more ports for incoming raw data through a specific protocol and parses and converts it to a javascript object. Then passes this object along to the [dispatcher](dispatcher.md). If a response comes back, the dock serializes it and sends it off to the original device.

More that one dock can be arranged for a single protocol, provided that they listen to different ports.

Docks must extend the base Dock class.


## Exposed Methods

### Methods that must be implemented

- **listen()** - Starts listening to the configured port.
- **stop()** - Stops listening to the port.
- **send(response)** *(optional)* - Sends the response to the original device.

### Methods present in the base class

- **validate(message)** - Validates the message length against the configured max and performs a format check. This method can be overriden if needed.
- **parse(data, meta)** - Parses the raw data and converts it to a javascript object. This is a default implementation provided for convenience that can and should be overriden to suit your needs.
- **process(message, meta, callback)** - Calls `validate()` and `parse()` and sends the result to the dispatcher.
- **encode(response)** - Serializes the response. This is a default implementation provided for convenience that can and should be overriden to suit your needs.
- **reply(response)** - If `send()` if defined, calls `encode()` and pipes the result to `send()`.


## Exposed Properties

### Getters that must be implemented

- **path** *(string)* - Returns the path of the dock file.
Example:
```javascript
    get path() {
        return __filename;
    }
```

### Getters present in the base class

- **id** *(string)* - Returns the dock id, an unique string that is autogenerated every time the app runs.
- **name** *(string)* - Returns the dock name.
- **protocol** *(string)* - Returns the dock protocol.
- **port** *(integer)* - Returns the configured port.
- **config** *(string)* - Returns the config object.


## Events

### Emits

- **data** - Triggered every time the dock receives a new message. Gives the handler access to the raw, unprocessed data. Useful to proxy it somewhere else.
- **response** - When the dock receives a response from the dispatcher.
- **invalidMessage** - Triggered when a message does not pass `validate()` filters, or when the message either is not a string, or does not have a `toString()` method.


## Configuration

```javascript
{
    port: 5000,
    parser: {
        subtagSeparator: '#',
        dataSeparator: '.'
    },
    encoder: {
        subtagSeparator: '#',
        dataSeparator: '.'
    },
    maxMessageLength: 100
}
```

- **port** *(integer)* - The port to listen to.
- **parser** *(object, optional)* - If you're using the default parser, you can configure the subtag and data separators. The defaults are `|` for `subtagSeparator` and `,` for `dataSeparator`.
- **encoder** *(object, optional)* - Idem parser.
- **maxMessageLength** *(integer, optional)* - The max length in characters of a message. If not set, the default is `300`.